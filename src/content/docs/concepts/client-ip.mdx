---
description: "How the client IP is detected in Arcjet and how to change that."
frameworks:
  - astro
  - bun-hono
  - bun
  - deno
  - fastify
  - nest-js
  - next-js
  - node-js-express
  - node-js-hono
  - node-js
  - nuxt
  - react-router
  - remix
  - sveltekit
next: false
prev: false
title: "Client IP"
ajToc:
  - anchor: "overview"
    text: "Overview"
  - anchor: "framework"
    text: "Framework"
  - anchor: "platform"
    text: "Platform"
  - anchor: "proxies"
    children:
      - anchor: "ip-ranges"
        text: "IP ranges"
      - anchor: "proxy-stripping"
        text: "Proxy stripping"
    text: "Proxies"
  - anchor: "overwriting-client-ips"
    children:
      - anchor: "development"
        text: "Development"
      - anchor: "production"
        text: "Production"
    text: "Overwriting client IPs"
---

import { Code } from "@astrojs/starlight/components";
import SlotByFramework from "@/components/SlotByFramework";
import { removeTSCCommentDirectives as removeTypeScriptDirectives } from "@/lib/utils";
import AstroProxies from "/src/snippets/reference/astro/Proxies.mjs?raw";
import AstroService from "/src/snippets/reference/astro/Service.mjs?raw";
import AstroTrustedIp from "/src/snippets/reference/astro/TrustedIp.mjs?raw";
import BunProxies from "/src/snippets/reference/bun/Proxies.ts?raw";
import BunService from "/src/snippets/reference/bun/Service.ts?raw";
import BunTrustedIp from "/src/snippets/reference/bun/TrustedIp.ts?raw";
import DenoProxies from "/src/snippets/reference/deno/proxies.ts?raw";
import DenoService from "/src/snippets/reference/deno/service.ts?raw";
import DenoTrustedIp from "/src/snippets/reference/deno/trusted-ip.ts?raw";
import FastifyProxies from "/src/snippets/reference/fastify/proxies.ts?raw";
import FastifyService from "/src/snippets/reference/fastify/service.ts?raw";
import FastifyTrustedIp from "/src/snippets/reference/fastify/trusted-ip.ts?raw";
import NestProxies from "/src/snippets/reference/nestjs/Proxies.ts?raw";
import NestService from "/src/snippets/reference/nestjs/Service.ts?raw";
import NestTrustedIp from "/src/snippets/reference/nestjs/TrustedIp.ts?raw";
import NextProxies from "/src/snippets/reference/nextjs/Proxies.ts?raw";
import NextService from "/src/snippets/reference/nextjs/Service.ts?raw";
import NextTrustedIp from "/src/snippets/reference/nextjs/TrustedIp.ts?raw";
import NodeProxies from "/src/snippets/reference/nodejs/Proxies.ts?raw";
import NodeService from "/src/snippets/reference/nodejs/Service.ts?raw";
import NodeTrustedIp from "/src/snippets/reference/nodejs/TrustedIp.ts?raw";
import NuxtProxies from "@repo/nuxt/server/utils/ProxiesConfig.ts?raw";
import NuxtService from "@repo/nuxt/server/utils/Service.ts?raw";
import NuxtTrustedIp from "@repo/nuxt/server/utils/TrustedIp.ts?raw";
import ReactRouterProxies from "/src/snippets/reference/react-router/proxies.ts?raw";
import ReactRouterService from "/src/snippets/reference/react-router/service.ts?raw";
import ReactRouterTrustedIp from "/src/snippets/reference/react-router/trusted-ip.ts?raw";
import RemixProxies from "/src/snippets/reference/remix/Proxies.ts?raw";
import RemixService from "/src/snippets/reference/remix/Service.ts?raw";
import RemixTrustedIp from "/src/snippets/reference/remix/TrustedIp.ts?raw";
import SveltekitProxies from "/src/snippets/reference/sveltekit/Proxies.ts?raw";
import SveltekitService from "/src/snippets/reference/sveltekit/Service.ts?raw";
import SveltekitTrustedIp from "/src/snippets/reference/sveltekit/TrustedIp.ts?raw";

<div aria-hidden="true" style={{ display: "none" }}>

```sh
ignore-me
```

</div>

Arcjet needs the public IP address of incoming requests for much of what it does.
By default,
Arcjet uses the IP as a `characteristic` to differentiate users.
If that doesn’t work correctly,
several good users may be denied access because they cannot be differentiated
from a bad user.
Or a malicious user could get around rate limits by appearing as different
users.
Arcjet also uses the client IP for geolocation and other reflected metadata.

Finding the correct client IP address is tricky.
How to find that IP depends on the framework you build with,
the platform you deploy to,
and whether there are proxies or similar services in front of it.

When developing an app locally,
there is no public client IP.
When testing Arcjet,
it is often needed to overwrite the IP.

## Framework

Each Arcjet SDK is made for a particular framework and detects the client IP
correctly from incoming requests out of the box.
Some frameworks provide that IP address on the request directly
(such as `request.ip` and `request.requestContext.identity.sourceIp`),
in other cases it can be inferred from headers
(see the next section “[Platform][section-platform]”).

The found IP may be of a proxy or other service in front of your application.
See the section “[Proxies][section-proxies]” for these cases.

If no IP is detected in production,
you’ll see a big warning in the logs.
In this case,
if you do know where to find the correct IP address,
you can [overwrite the client IP][section-overwrite-ip].
But please also [open an issue][arcjet-arcjet-js-issues] so that this bug can
be fixed.

## Platform

Arcjet looks at request headers when frameworks do not provide the client IP
directly or when it matches a configured proxy.
Which headers to trust depends on the platform your app runs on.
Arcjet infers whether an app runs on Firebase, Fly, Render, or Vercel
(but not Cloudflare) from the environment.
On other platforms Arcjet looks for common headers.

The considered environment variables and their corresponding platforms are as
follows:

{/* TODO: link to https://github.com/arcjet/arcjet-docs/pull/716 when that lands. */}

| Environment variable                        | Platform     |
| ------------------------------------------- | ------------ |
| [`FIREBASE_CONFIG`][google-firebase-config] | **Firebase** |
| [`FLY_APP_NAME`][fly-app-name]              | **Fly**      |
| [`RENDER`][render-render]                   | **Render**   |
| [`VERCEL`][vercel-vercel]                   | **Vercel**   |

The considered headers, their formats, and their corresponding platforms are as
follows:

| Header                                                    | Format              | Platforms                         |
| --------------------------------------------------------- | ------------------- | --------------------------------- |
| [`cf-connecting-ipv6`][cloudflare-cf-connecting-ipv6]     | IPv6                | **Cloudflare**                    |
| [`cf-connecting-ip`][cloudflare-cf-connecting-ip]         | IP                  | **Cloudflare**                    |
| [`do-connecting-ip`][digitalocean-do-connecting-ip]       | IP                  | Unknown                           |
| [`fastly-client-ip`][fastly-client-ip]                    | IP                  | Unknown                           |
| [`fly-client-ip`][fly-client-ip]                          | IP                  | **Fly**                           |
| `forwarded-for`                                           | IP                  | Unknown                           |
| [`forwarded`][mdn-forwarded]                              | RFC 7239            | Unknown                           |
| `true-client-ip`                                          | IP                  | **Render**, unknown               |
| [`x-appengine-user-ip`][google-app-engine-user-ip]        | IP                  | Unknown                           |
| `x-client-ip`                                             | IP                  | Unknown                           |
| `x-cluster-client-ip`                                     | IP                  | Unknown                           |
| `x-fah-client-ip`                                         | IP                  | **Firebase**                      |
| [`x-forwarded-for`][mdn-x-forwarded-for]                  | Comma-separated IPs | **Firebase**, **Vercel**, unknown |
| `x-forwarded`                                             | IP                  | Unknown                           |
| `x-real-ip`                                               | IP                  | **Vercel**, unknown               |
| [`x-vercel-forwarded-for`][vercel-x-vercel-forwarded-for] | Comma-separated IPs | **Vercel**                        |

When using platforms not listed here and you know which header to trust,
you can [overwrite the client IP][section-overwrite-ip].
It is important to trust this header because headers can be set by end users.
If your platform does not set for example `x-client-ip` but a malicious user
sets it,
that untrusted value would be used.

If you use a platform not listed here which can be detected from the
environment and sets certain headers,
please [open an issue][arcjet-arcjet-js-issues] so that trusted support can be
added for it.

## Proxies

When you put services like proxies or load balancers in front of your
application,
the IP address that Arcjet finds will be that of the last proxy.

Well-behaving services will use an `x-forwarded-for` or `forwarded` header to
forward the IP addresses that connect to them.

Because malicious users can also set headers,
the left-most value in such headers cannot be trusted.
But the right-most value of these well-behaving services _can_ be trusted.
And when that IP belongs to another service that you trust,
the one before it can be used.

To illustrate,
when you put a service like Cloudflare in front of your application,
and know that it sets headers correctly,
and know which IP addresses belong to it,
after verifying that the IP belongs to it,
you trust the IP _before_ it.

Setting `proxies` works as follows:

<SlotByFramework client:load>
  <Code
    code={removeTypeScriptDirectives(AstroProxies)}
    lang="js"
    slot="astro"
  />
  <Code code={BunProxies} lang="ts" slot="bun-hono" />
  <Code code={BunProxies} lang="ts" slot="bun" />
  <Code code={DenoProxies} lang="ts" slot="deno" />
  <Code code={FastifyProxies} lang="ts" slot="fastify" />
  <Code code={NestProxies} lang="ts" slot="nest-js" />
  <Code code={NextProxies} lang="ts" slot="next-js" />
  <Code code={NodeProxies} lang="ts" slot="node-js-express" />
  <Code code={NodeProxies} lang="ts" slot="node-js-hono" />
  <Code code={NodeProxies} lang="ts" slot="node-js" />
  <Code code={removeTypeScriptDirectives(NuxtProxies)} lang="ts" slot="nuxt" />
  <Code code={ReactRouterProxies} lang="ts" slot="react-router" />
  <Code code={RemixProxies} lang="ts" slot="remix" />
  <Code code={SveltekitProxies} lang="ts" slot="sveltekit" />
</SlotByFramework>

Which values to pass in `proxies` depends on your setup.
Most services provide a list of their IP ranges as JSON.

It is not needed to configure
documentation (`192.0.2.1`),
benchmarking (`198.19.255.255`),
broadcast (`255.255.255.255`),
link local (`169.254.255.255`),
loopback (`127.0.0.1`),
private (such as `10.1.1.1`),
reservered (`192.0.0.1`), or
shared (`100.127.255.255`)
IP addresses.
Whether IPv4 or IPv6, those are automatically filtered out.

### IP ranges

#### Cloudflare

You can fetch Cloudflare IP ranges as follows:

```ts
const [cloudflareIpv4, cloudflareIpv6] = await Promise.all(
  [
    "https://www.cloudflare.com/ips-v4/",
    "https://www.cloudflare.com/ips-v6/",
  ].map(async function (url) {
    const response = await fetch(url);
    const body = await response.text();
    return body.trim().split("\n");
  }),
);
const cloudflare = [...cloudflareIpv4, ...cloudflareIpv6].toSorted();
// You can now pass `...cloudflare` in `proxies`.
```

#### Google

You can fetch Google IP ranges as follows:

```ts
/**
 * Google IP prefix info.
 */
interface GooglePrefixBaseFields {
  /**
   * Region.
   */
  scope?: string;
  /**
   * Service.
   */
  service?: "Google Cloud";
}

/**
 * Google IPv4 prefix info.
 */
interface GooglePrefixIpv4 extends GooglePrefixBaseFields {
  /**
   * CIDR range.
   */
  ipv4Prefix: string;
}

/**
 * Google IPv6 prefix info.
 */
interface GooglePrefixIpv6 extends GooglePrefixBaseFields {
  /**
   * CIDR range.
   */
  ipv6Prefix: string;
}

/**
 * Google IP ranges response.
 */
interface GoogleResponse {
  /**
   * Creation date.
   */
  createDate: string;
  /**
   * List of IP prefixes.
   */
  prefixes: Array<GooglePrefixIpv4 | GooglePrefixIpv6>;
  /**
   * Sync token.
   */
  syncToken: string;
}

const googleResponse = await fetch(
  "https://www.gstatic.com/ipranges/goog.json",
);
const googleBody = (await googleResponse.json()) as GoogleResponse;
const google = googleBody.prefixes
  .map(function (d) {
    return "ipv4Prefix" in d ? d.ipv4Prefix : d.ipv6Prefix;
  })
  .toSorted();
// You can now pass `...google` in `proxies`.
```

### Proxy stripping

If you use proxies but deploy to a platform such as Vercel which strips headers
like `x-forwarded-for` (except when on an enterprise plan),
you can pass a record in `proxies`.
This works similarly:
when you know that Cloudflare sets headers correctly,
and know which IP addresses belong to it,
after verifying that the IP you get from Vercel belongs to Cloudflare,
you trust the IP in Cloudflare’s headers.

<SlotByFramework client:load>
  <Code
    code={removeTypeScriptDirectives(AstroService)}
    lang="js"
    slot="astro"
  />
  <Code code={BunService} lang="ts" slot="bun-hono" />
  <Code code={BunService} lang="ts" slot="bun" />
  <Code code={DenoService} lang="ts" slot="deno" />
  <Code code={FastifyService} lang="ts" slot="fastify" />
  <Code code={NestService} lang="ts" slot="nest-js" />
  <Code code={NextService} lang="ts" slot="next-js" />
  <Code code={NodeService} lang="ts" slot="node-js-express" />
  <Code code={NodeService} lang="ts" slot="node-js-hono" />
  <Code code={NodeService} lang="ts" slot="node-js" />
  <Code code={removeTypeScriptDirectives(NuxtService)} lang="ts" slot="nuxt" />
  <Code code={ReactRouterService} lang="ts" slot="react-router" />
  <Code code={RemixService} lang="ts" slot="remix" />
  <Code code={SveltekitService} lang="ts" slot="sveltekit" />
</SlotByFramework>

## Overwriting client IPs

It is possible to overwrite the client IP address.
To make this easy locally but secure when deployed,
how to do this is different in development and production.

{/* TODO: explain how to use env variables and link to https://github.com/arcjet/arcjet-docs/pull/716 when that lands. */}

### Development

In development you can pass an `x-arcjet-ip` header.
This value is preferred over any other detected IP address.
An example with Curl is:

```sh
curl https://example.com --header "x-arcjet-ip: 76.76.21.21" --verbose
```

This header is ignored in production because otherwise malicious users could
set it.
But in development it is useful to simulate different client IP addresses
without changing code and restarting your app,
and to check how that affects Arcjet behavior,
particularly around rate limiting and IP geolocation.

### Production

In production,
if the client IP is in a header that you trust,
you can pas a `trustedIpHeader` option.

<SlotByFramework client:load>
  <Code
    code={removeTypeScriptDirectives(AstroTrustedIp)}
    lang="js"
    slot="astro"
  />
  <Code code={BunTrustedIp} lang="ts" slot="bun-hono" />
  <Code code={BunTrustedIp} lang="ts" slot="bun" />
  <Code code={DenoTrustedIp} lang="ts" slot="deno" />
  <Code code={FastifyTrustedIp} lang="ts" slot="fastify" />
  <Code code={NestTrustedIp} lang="ts" slot="nest-js" />
  <Code code={NextTrustedIp} lang="ts" slot="next-js" />
  <Code code={NodeTrustedIp} lang="ts" slot="node-js-express" />
  <Code code={NodeTrustedIp} lang="ts" slot="node-js-hono" />
  <Code code={NodeTrustedIp} lang="ts" slot="node-js" />
  <Code
    code={removeTypeScriptDirectives(NuxtTrustedIp)}
    lang="ts"
    slot="nuxt"
  />
  <Code code={ReactRouterTrustedIp} lang="ts" slot="react-router" />
  <Code code={RemixTrustedIp} lang="ts" slot="remix" />
  <Code code={SveltekitTrustedIp} lang="ts" slot="sveltekit" />
</SlotByFramework>

[arcjet-arcjet-js-issues]: https://github.com/arcjet/arcjet-js/issues
[cloudflare-cf-connecting-ipv6]: https://developers.cloudflare.com/fundamentals/reference/http-request-headers/#cf-connecting-ipv6
[cloudflare-cf-connecting-ip]: https://developers.cloudflare.com/fundamentals/reference/http-request-headers/#cf-connecting-ip
[digitalocean-do-connecting-ip]: https://docs.digitalocean.com/support/where-can-i-find-the-client-ip-address-of-a-request-connecting-to-my-app/
[fastly-client-ip]: https://www.fastly.com/documentation/reference/http/http-headers/Fastly-Client-IP/
[fly-app-name]: https://fly.io/docs/machines/runtime-environment/#fly_app_name
[fly-client-ip]: https://www.fly.io/docs/networking/request-headers/#fly-client-ip
[google-app-engine-user-ip]: https://cloud.google.com/appengine/docs/legacy/standard/java/reference/request-response-headers
[google-firebase-config]: https://firebase.google.com/docs/functions/config-env
[mdn-forwarded]: https://developer.mozilla.org/en-US/docs/Web/HTTP/Reference/Headers/Forwarded
[mdn-x-forwarded-for]: https://developer.mozilla.org/en-US/docs/Web/HTTP/Reference/Headers/X-Forwarded-For
[render-render]: https://render.com/docs/environment-variables#render-62
[section-overwrite-ip]: #overwriting-client-ips
[section-platform]: #platform
[section-proxies]: #proxies
[vercel-vercel]: https://vercel.com/docs/environment-variables/system-environment-variables#VERCEL
[vercel-x-vercel-forwarded-for]: https://vercel.com/docs/headers/request-headers#x-vercel-forwarded-for
