---
import { pathnameForSdk, sdk, sdkFromPathname, sdks } from "@/lib/sdk";
import Default from "@astrojs/starlight/components/MobileTableOfContents.astro";
import { Icon } from "@astrojs/starlight/components";

const activeSdkKey = sdkFromPathname(Astro.url.pathname);
const activeSdk = activeSdkKey ? sdk(activeSdkKey) : undefined;
---

{/* TODO: Remove once framework switching is removed. */}
{
    !activeSdk && (
        <div class="todo-remove">
            <Default />
        </div>
    )
}
{
    activeSdk && (
        <div class="mtoc-wrapper">
            <div class="mtoc-container">
                <div class="mtoc-sdk-control">
                    <button
                        class="mtoc-sdk-toggle"
                        popovertarget="mtoc-sdk"
                        type="button"
                    >
                        {activeSdk.ReactIcon && <activeSdk.ReactIcon />}
                        {activeSdk.label}
                        <Icon class="caret" name="right-caret" size="1rem" />
                    </button>
                </div>
                <nav id="mtoc-sdk" popover>
                    <ul>
                        {sdks().map((sdkItem) => {
                            const isCurrent = sdkItem.key === activeSdk.key;

                            return (
                                <li>
                                    <a
                                        aria-current={
                                            isCurrent ? "true" : undefined
                                        }
                                        href={pathnameForSdk(
                                            Astro.url.pathname,
                                            sdkItem.key,
                                        )}
                                    >
                                        {sdkItem.ReactIcon && (
                                            <sdkItem.ReactIcon />
                                        )}
                                        {sdkItem.label}
                                        {isCurrent && (
                                            <Icon
                                                class="check"
                                                name="approve-check"
                                                size="1rem"
                                            />
                                        )}
                                    </a>
                                </li>
                            );
                        })}
                    </ul>
                </nav>
                <Default />
            </div>
        </div>
    )
}

<style>
    @layer starlight, arcjet;

    @layer arcjet.overrides {
        .mtoc-wrapper {
            mobile-starlight-toc {
                min-width: 0;

                nav {
                    position: unset;
                    border: none;

                    summary {
                        border: none;
                        gap: calc(var(--sp) * 2);
                        padding: 0;
                    }

                    .toggle {
                        border: none;
                    }

                    .dropdown {
                        position: fixed;
                        left: var(--mtoc-left);
                        right: 0;
                        width: 100vw;
                        max-width: calc(100vw - var(--mtoc-left));
                        z-index: 2;

                        top: calc(var(--Header-height) + var(--mtoc-height));

                        overflow-y: auto;

                        border: none;
                        backdrop-filter: blur(var(--blur1));
                        background: linear-gradient(
                            rgba(var(--colorBgRgb) / 1) 8px,
                            rgba(var(--colorBgRgb) / 0)
                        );

                        padding: 0 var(--sl-content-pad-x) calc(var(--sp) * 3);

                        a {
                            border: 0px;

                            border-radius: calc(var(--sp) * 0.5);
                            color: var(--aj-palette-txt-tertiary);

                            transition: all var(--time-sm) var(--easing-default);

                            outline: none;

                            padding: calc(var(--sp) * 1) calc(var(--sp) * 1);
                            margin: calc(var(--sp) * 0.2) 0;
                            margin-left: calc(1rem * var(--depth));

                            &:hover,
                            &:focus {
                                background: var(--sidebar-link-hoverBg);
                                color: var(--aj-palette-txt-tertiary);
                            }

                            &:active {
                                background: var(--sidebar-link-activeBg);
                            }

                            &[aria-current="true"] {
                                color: var(--aj-palette-txt-primary);
                                background: var(--sidebar-link-selectedBg);
                            }
                        }
                    }
                }
            }
        }
    }

    @layer arcjet.components {
        .mtoc-wrapper {
            --mtoc-left: 0;
            --mtoc-height: calc(8px * 11);

            position: fixed;
            top: var(--Header-height);
            height: var(--mtoc-height);
            width: 100%;
            z-index: 1;
        }

        @media (min-width: 50rem) {
            .mtoc-wrapper {
                --mtoc-left: var(--Sidebar-width);
            }
        }

        .mtoc-container {
            background-color: rgb(var(--colorBgRgb));
            box-sizing: border-box;
            display: flex;
            gap: calc(var(--sp) * 2);
            height: var(--mtoc-height);
            padding: calc(var(--sp) * 3) var(--sl-content-pad-x);
            position: relative;
            z-index: 1;
        }

        .mtoc-sdk-control {
            --caret-degrees: 0deg;
            --color: var(--aj-palette-txt-secondary);

            align-self: end;
            display: flex;

            &:has(+ #mtoc-sdk:popover-open) {
                --caret-degrees: 90deg;
                --color: var(--aj-palette-txt-primary);
            }

            svg {
                color: var(--color);
                height: 16px;
                width: 16px;
            }

            /* Match starlight "Content" button */
            button {
                align-items: center;
                background-color: var(--sl-color-black);
                border-radius: 0.5rem;
                border: none;
                color: var(--color);
                display: flex;
                flex-shrink: 0;
                gap: 0.5rem;
                justify-content: space-between;
                line-height: 1;
                font-size: var(--sl-text-xs);
                padding-block: 0.5rem;
                padding-inline-end: 0.5rem;
                padding-inline-start: 0.5rem;
                user-select: none;
            }

            .caret {
                transform: rotate(var(--caret-degrees));
            }
        }

        .mtoc-sdk-toggle:active {
            color: var(--aj-palette-txt-primary);
        }

        /* Disable mtoc gradient when sdk popover or .dropdown open */
        :root:not(:has(#mtoc-sdk:popover-open))
            .mtoc-container:has(mobile-starlight-toc details:not([open])) {
            backdrop-filter: blur(var(--blur1));
            background: linear-gradient(
                rgba(var(--colorBgRgb) / 1) 8px,
                rgba(var(--colorBgRgb) / 0)
            );
        }

        #mtoc-sdk[popover] {
            backdrop-filter: blur(var(--blur1));
            background: linear-gradient(
                rgba(var(--colorBgRgb) / 1) 8px,
                rgba(var(--colorBgRgb) / 0)
            );
            border: none;
            left: var(--mtoc-left);
            /* match MobileTableOfContents .dropdown */
            max-height: calc(
                85vh - var(--sl-nav-height) - var(--sl-mobile-toc-height)
            );
            overflow-y: auto;
            padding: 0 var(--sl-content-pad-x) calc(var(--sp) * 3);
            position: fixed;
            right: 0;
            width: calc(100vw - var(--mtoc-left));
            top: calc(var(--Header-height) + var(--mtoc-height));
            z-index: 1;

            ul {
                list-style: none;
                margin: 0;
                padding: 0;
            }

            li {
                margin: 0;
                padding: 0;
            }

            /* Match .dropdown link styles */
            a {
                align-items: center;
                border-radius: calc(var(--sp) * 0.5);
                color: var(--aj-palette-txt-tertiary);
                display: flex;
                font-size: var(--sl-text-sm);
                gap: calc(var(--sp) * 1);
                margin: 0;
                outline: none;
                transition: all var(--time-sm) var(--easing-default);
                line-height: 1;

                padding: calc(var(--sp) * 1) calc(var(--sp) * 1);
                margin: calc(var(--sp) * 0.2) 0;
                margin-left: calc(1rem * var(--depth));
                width: 100%;

                text-decoration: none;

                svg {
                    height: 16px;
                    width: 16px;
                }

                .check {
                    margin-left: auto;
                }
            }

            a:hover,
            a:focus {
                background: var(--sidebar-link-hoverBg);
                color: var(--aj-palette-txt-tertiary);
            }

            a:active {
                background: var(--sidebar-link-activeBg);
            }

            a[aria-current="true"] {
                color: var(--aj-palette-txt-primary);
                background: var(--sidebar-link-selectedBg);
            }
        }
    }
</style>
